# Recommendation: Place this file in source control.
# Auto-generated by `./dk dksdk.project.new` of SquirrelScout.
#
# You can and should edit this file as you add dependencies.
# The auto-generated dependencies include a mix of C and OCaml
# to help you understand how to grab both types of dependencies.

include(DkSDKFetchContent)
include(DkSDKProject)
DkSDKProject_AddDependencies()

# ////// START OF SILLY SECTION.
# ////// Only required for `#include "dksdk_ffi_c/dksdk_ffi_c.h"`
# ////// in generic-ffi-main.c.
# ////// 
# ////// DkSDKRequire_Add(FFI OCaml PRERELEASE) 
# ////// or DkSDKRequire_Add(FFI C) should expose the C headers needed
# ////// by generic-ffi-main.c.

# --- Set dksdk-ffi-c_REPOSITORY

get_property(dksdk-ffi-c_REPOSITORY GLOBAL PROPERTY DKSDK_FFI_C_REPOSITORY)

# --- Fetch dksdk-ffi-c

DkSDKFetchContent_DeclareSecondParty(NAME dksdk-ffi-c
    ALLOW_OUTSIDE_SOURCE_TREE
    GIT_REPOSITORY "${dksdk-ffi-c_REPOSITORY}"
    GIT_TAG main)
# MSVC Fatal error: Unsupported relocation kind 0003 for __GSHandlerCheck in _deps\dksdk-ffi-c-build\src\dksdk_ffi_c-StaticExports.lib(_deps\dksdk-ffi-c-build\src\CMakeFiles\dksdk_ffi_c-StaticExports.dir\sha256.c.obj)
function(do_fetch_dksdk_ffi_c)
    if(MSVC AND DKSDK_FFI_OCAML_MITIGATE_MSVC_RELOCATION_KIND_0003_COMPILE_OPTIONS)
        string(JOIN " " compileOptions ${DKSDK_FFI_OCAML_MITIGATE_MSVC_RELOCATION_KIND_0003_COMPILE_OPTIONS})
        string(APPEND CMAKE_C_FLAGS " ${compileOptions}")
    endif()

    DkSDKFetchContent_MakeAvailableNoInstall(dksdk-ffi-c)
endfunction()
do_fetch_dksdk_ffi_c()

# ////// END OF SILLY SECTION.

# --- Declare Dependencies ---

# >>> If you have any FetchContent_Declare(), this is the place
# >>> to put them.

# >>> If you have any DkSDKProject_DeclareAvailable(), this is the place
# >>> to put them.

# DkSDKProject_DeclareAvailable(capnp 
#     CONSTRAINT ">= 3.6.0"
#     FINDLIBS capnp 
# )

DkSDKProject_DeclareAvailable(qrc
    CONSTRAINT ">= 0.1.0"
    FINDLIBS qrc 
)

DkSDKProject_DeclareAvailable(ocamlbuild
    CONSTRAINT ">= 0.14.2"
    FINDLIBS ocamlbuildlib
)

DkSDKProject_DeclareAvailable(vector
    CONSTRAINT ">= 1.0.0"
    FINDLIBS vector 
)

DkSDKProject_DeclareAvailable(yojson
    CONSTRAINT ">= 2.1.0"
    FINDLIBS yojson 
)

# [core] is a Jane Street library. Jane Street, because it does not have a Windows
# test system, frequently has Windows problems. So DkSDK and DkML usually avoid
# Jane Street libraries except a few low-dependencies packages like [base] and
# some PPX libraries. Example: https://github.com/janestreet/core/pull/166
# ==> Avoid [core]!
DkSDKProject_DeclareAvailable(core
    CONSTRAINT ">= 0.16.0"
    FINDLIBS core base_for_tests command core_top filename_base heap_block univ_map validate 
)

DkSDKProject_DeclareAvailable(base64
    CONSTRAINT ">= 3.5.1"
    FINDLIBS base64
)

DkSDKProject_DeclareAvailable(xdg
    CONSTRAINT ">= 3.12.2"
    FINDLIBS xdg
)

DkSDKProject_DeclareAvailable(xdg
    CONSTRAINT ">= 3.12.2"
    FINDLIBS xdg
)

DkSDKProject_DeclareAvailable(fpath
    CONSTRAINT ">= 0.7.3"
    FINDLIBS fpath
)

DkSDKProject_DeclareAvailable(bos
    CONSTRAINT ">= 0.2.1"
    FINDLIBS bos
)

# --- Which Dependencies Will Be Available To Targets ---

# Using DkSDKProject_DeclareAvailable() alone does not pull it into CMake.
# You also have to use DkSDKProject_MakeAvailable(xxx FINDLIBS yyy) and use a
# target_link_libraries() on one of the `yyy`.

if(SONIC_SCOUT_FEATURE_COM)
    if(SONIC_SCOUT_NATIVE_COM)
        DkSDKProject_MakeAvailable(
                # need capnpc-ocaml executable to generate Schema.{java,ml}
                capnp_ocaml
        )
        DkSDKProject_MakeAvailable(
                cmdliner
                fmt
                logs
                lwt

                capnp_ocaml
                qrc
                vector
                yojson
                core
                base64
                sqlite3
                xdg
                fpath
                bos
        )

        DkSDKProject_MakeAvailable(TEST
                tezt)
    else()
        # Fetch capnnc-ocaml executable directly. Only available for Win32 64-bit though!
        include(ExternalProject)
        set(exe capnpc-ocaml${CMAKE_EXECUTABLE_SUFFIX})
        ExternalProject_Add(capnpc-ocaml-proj
            # TODO: Migrate to asset link. And fold this entire ExternalProject_Add into DkSDK CMake (maybe in DkSDKOCaml.cmake)
            URL "https://github.com/diskuv/scoutapps/releases/download/2024.06.28/capnpc-ocaml.exe"
            URL_HASH SHA256=ed9d55a306fff3f11befb131b781a690b7dbe1ad3857630b077eab00e83adec5
            DOWNLOAD_NO_EXTRACT ON
            CONFIGURE_COMMAND ""
            BUILD_COMMAND ""
            INSTALL_COMMAND ${CMAKE_COMMAND} -D "SRCFILE=<DOWNLOADED_FILE>" -D "DESTFILE=<INSTALL_DIR>/${exe}" -P "${CMAKE_CURRENT_LIST_DIR}/install-exe.script.cmake"
            TEST_COMMAND ""
            #   [CMake < 3.26]
            #   If CMake >= 3.26, we could use INSTALL_BYPRODUCTS instead.
            #   Confer: "Common Issues" section of Professional CMake.
            BUILD_BYPRODUCTS <INSTALL_DIR>/${exe}
            STEP_TARGETS install
        )
        ExternalProject_Get_Property(capnpc-ocaml-proj INSTALL_DIR)
        #   [CMake < 3.26]
        #   Require [capnpc-ocaml] target to use the Install step of the above ExternalProject.
        #   If CMake >= 3.26, we could use INSTALL_BYPRODUCTS instead, and remove this [add_dependencies]
        #   Confer: "Common Issues" section of Professional CMake.
        add_executable(capnpc-ocaml IMPORTED GLOBAL)
        add_dependencies(capnpc-ocaml capnpc-ocaml-proj-install)
        set_target_properties(capnpc-ocaml PROPERTIES IMPORTED_LOCATION "${INSTALL_DIR}/${exe}")
    endif()
endif()

DkSDKFetchContent_MakeAvailableNoInstall(
    # "Build tools" that must run on the build host.
    # Implementation: Built by CMake directly.

    capnproto_and_host_tools
    capnproto_java_and_host_tools
)

add_subdirectory(zxing)

if(SONIC_SCOUT_FEATURE_COM AND SONIC_SCOUT_NATIVE_COM)
    DkSDKRequire_Add(FFI OCaml)
endif()
